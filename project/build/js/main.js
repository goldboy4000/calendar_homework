!function(n){"use strict";var e,i=function(){e=new Calendar,e.init().render()};n.addEventListener("load",i)}(window);
function Calendar(){var e=["ПН","ВТ","СР","ЧТ","ПТ","СБ","ВС"];this.chosenDay=(new Date).getDate();var t=[].shift.call(arguments)||(new Date).getMonth(),n=[].shift.call(arguments)||(new Date).getFullYear();this.__defineGetter__("month",function(){return t}),this.__defineGetter__("year",function(){return n}),this.id="calendar",this.selector="#"+this.id;this.tasks=[],this.tasksLocalStorageKey="tasks",this.modal=new Modal(".modal");var a=function(e){var t=document.createElement("div");return t.className="columns",t.appendChild(getColumn(getButton("previous","","fa fa-arrow-circle-o-left"))),t.appendChild(getColumn(getTag("date","title","is-primary","is-large",e),"is-three-quarters")),t.appendChild(getColumn(getButton("next","","fa fa-arrow-circle-o-right"))),t},r=function(){var t=document.createElement("thead"),n=document.createElement("tr");t.appendChild(n);for(var a=0;a<e.length;a++)n.appendChild(i(e[a]));return t},i=function(e){var t=document.createElement("th");return t.innerHTML=e,t},s=function(){for(var e=document.createElement("tbody"),a=new Date(n,t),r=0===a.getDay()?7:a.getDay(),i=a.daysInMonth(),s=1,o=[],d=!0,c=0;c<a.fullWeeksInMonth();c++){o[c]=document.createElement("tr"),e.appendChild(o[c]);for(var l=1;l<=7;l++)column=document.createElement("td"),l<r&&d||s>i?column.innerHTML="&nbsp":(column.setAttribute("id","day"+s),column.innerHTML=s++,d=!1),o[c].appendChild(column)}return e},o=function(){var e=document.createElement("table");return e.className="table is-bordered",e.setAttribute("id",this.id),e.appendChild(r()),e.appendChild(s()),e},d=function(){var e=document.createElement("ul");return e.setAttribute("class","task_list"),e};this.addTask=function(e,t,n,a){var r=new Task(a,new Date(n,t,e));return this.tasks.push(r),this},this.removeTask=function(e){return this.tasks.forEach(function(t,n){t instanceof Task&&t.id===e&&this.tasks.splice(n,1)}.bind(this)),this},this.loadTasksFromStorage=function(){var e=localStorage.getItem(this.tasksLocalStorageKey);try{JSON.parse(e).forEach(function(e){var t=new Task(e.task,new Date(e.date));this.tasks.push(t)}.bind(this))}catch(e){this.tasks=[]}},this.setupHandlers=function(){document.querySelector("#calendar_nav_container").addEventListener("click",calendarNavClickHandler.bind(this));var e=document.querySelector("#calendar_container");e.addEventListener("click",calendarClickHandler.bind(this)),e.addEventListener("success",modalSuccessHandler.bind(this)),window.addEventListener("pagehide",exitFromPageHandler.bind(this))},this.init=function(){return this.setupHandlers(),this.loadTasksFromStorage(),this},this.renderNavigationPanel=function(){var e=document.querySelector("#calendar_nav_container");e.innerHTML="",e.appendChild(a(NAMES_OF_MONTHS[t]+" "+n))},this.renderCalendar=function(){var e=document.querySelector("#calendar_container"),t=e.querySelector(this.selector);t&&e.removeChild(t),e.appendChild(o.call(this))},this.renderTasks=function(){this.tasks.forEach(function(e){var n=document.querySelector(this.selector);if(e instanceof Task&&e.date.getMonth()===t){var a=n.querySelector("#day"+e.date.getDate()),r=a.querySelector(".task_list");r||(r=d(),a.insertBefore(r,a.childNodes[0])),r.appendChild(e.render())}}.bind(this))},this.render=function(){return t=[].shift.call(arguments)||t,n=[].shift.call(arguments)||n,this.renderNavigationPanel(),this.renderCalendar(),this.renderTasks(),this},this.previous=function(){return-1==--t&&(t=11,n--),this},this.next=function(){return 12==++t&&(t=0,n++),this},this.toJSON=function(){return this.tasks},this.saveTasksToStorage=function(){localStorage.removeItem(this.tasksLocalStorageKey),localStorage.setItem(this.tasksLocalStorageKey,JSON.stringify(this))}}function calendarClickHandler(e){var t=e.target;if("delete"===t.id){var n=+t.closest(".task").id;return void(isNaN(n)||this.removeTask(n).render())}var a=t.closest("td");a&&(this.chosenDay=a.id.slice(3),this.modal.show("Event on "+this.chosenDay+" "+NAMES_OF_MONTHS[this.month]+" "+this.year))}function modalSuccessHandler(e){this.addTask(this.chosenDay,this.month,this.year,e.detail.message).render()}function calendarNavClickHandler(e){for(var t=e.target;"calendar_nav_container"!==t.id;){if("previous"===t.id){this.previous().render();break}if("next"===t.id){this.next().render();break}t=t.parentNode}}function exitFromPageHandler(e){this.saveTasksToStorage()}var NAMES_OF_MONTHS=["January","February","March","April","May","June","July","August","September","October","November","December"];
function Modal(t){this.modal=document.querySelector(t),this.init()}Modal.prototype.init=function(){this.modal.addEventListener("click",this.modalClickHandler.bind(this)),this.modal.addEventListener("keyup",this.modalKeyUpHandler.bind(this)),this.modal.querySelector("#success_button").disabled=!0},Modal.prototype.modalClickHandler=function(t){var e=t.target;if("success_button"===e.id){var i=new CustomEvent("success",{detail:{message:this.modal.querySelector("#text_input").value},bubbles:!0});this.modal.dispatchEvent(i),this.hide()}"cancel_button"!==e.id&&"close_button"!==e.id||this.hide()},Modal.prototype.modalKeyUpHandler=function(t){var e=t.target;"text_input"===e.id&&(this.modal.querySelector("#success_button").disabled=!e.value)},Modal.prototype.show=function(t){this.modal.querySelector("#title").innerHTML=t||"New Event",this.modal.classList.add("is-active")},Modal.prototype.hide=function(){this.modal.querySelector("#text_input").value="",this.modal.classList.remove("is-active"),this.modal.querySelector("#success_button").disabled=!0};
function Task(t,e){var n=t;this.__defineGetter__("task",function(){return n});var r=e;this.__defineGetter__("date",function(){return r});var i=this.generateId();this.__defineGetter__("id",function(){return i}),this.render=function(){var t=document.createElement("li");return t.appendChild(getTag(this.id,"task","is-primary","is-small",this.task,!0)),t}}Task.prototype.generateId=function(){var t=0;return function(){return t++}}();
var getOption=function(e,t){var n=document.createElement("option");return n.value=e,n.innerHTML=t,n},findChild=function(e,t){for(var n=0;n<e.children.length;n++)if(e.children[n].tagName===t.toUpperCase())return e.children[n];return null},getButton=function(e,t,n){var a=document.createElement("a"),r=document.createElement("span");r.className="icon is-large",r.setAttribute("id",e),a.appendChild(r);var l=document.createElement("i");return l.className=n,l.innerHTML=t,r.appendChild(l),a},getTag=function(e,t,n,a,r,l){var i=document.createElement("span");i.className="tag",i.classList.add(t),i.classList.add(n),i.classList.add(a),i.setAttribute("id",e);var d=document.createTextNode(r);if(i.appendChild(d),l){var o=document.createElement("button");o.className="delete is-small",o.setAttribute("id","delete"),i.appendChild(o)}return i},getColumn=function(e,t){var n=document.createElement("div");return n.className="column",t&&n.classList.add(t),n.appendChild(e),n};Date.prototype.daysInMonth=function(){return 32-new Date(this.getFullYear(),this.getMonth(),32).getDate()},Date.prototype.fullWeeksInMonth=function(){var e=new Date(this.getFullYear(),this.getMonth(),1).getDay();e=0===e?7:e;var t=e-1+this.daysInMonth();return Number(Math.floor(t/7)+Boolean(t%7))};