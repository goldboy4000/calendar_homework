!function(n){"use strict";var e=function(){new Menu("#menu_container","show-button","month-selector","year-selector").init().render(),new Calendar("#calendar_nav_container","#calendar_container").init().render()};n.addEventListener("load",e)}(window);
function Calendar(e,t,n,a){var r=["ПН","ВТ","СР","ЧТ","ПТ","СБ","ВС"];this.chosenDay=(new Date).getDate();var i=isNaN(+n)?(new Date).getMonth():+n,s=isNaN(+a)?(new Date).getFullYear():+a;this.__defineGetter__("month",function(){return i}),this.__defineGetter__("year",function(){return s}),this.id="calendar",this.selector="#"+this.id;var o=e,d=t;this.tasks={},this.tasksLocalStorageKey="tasks",this.modal=new Modal(".modal");var c=function(e){var t=document.createElement("div");return t.className="columns",t.appendChild(getColumn(getButton("previous","","fa fa-arrow-circle-o-left"))),t.appendChild(getColumn(getTag("date","title","is-primary","is-large",e),"is-three-quarters")),t.appendChild(getColumn(getButton("next","","fa fa-arrow-circle-o-right"))),t},l=function(){var e=document.createElement("thead"),t=document.createElement("tr");e.appendChild(t);for(var n=0;n<r.length;n++)t.appendChild(h(r[n]));return e},h=function(e){var t=document.createElement("th");return t.innerHTML=e,t},u=function(){for(var e=document.createElement("tbody"),t=new Date(s,i),n=0===t.getDay()?7:t.getDay(),a=t.daysInMonth(),r=1,o=[],d=!0,c=0;c<t.fullWeeksInMonth();c++){o[c]=document.createElement("tr"),e.appendChild(o[c]);for(var l=1;l<=7;l++)column=document.createElement("td"),l<n&&d||r>a?column.innerHTML="&nbsp":(column.setAttribute("id","day"+r),column.innerHTML=r++,d=!1),o[c].appendChild(column)}return e},m=function(){var e=document.createElement("table");return e.className="table is-bordered",e.setAttribute("id",this.id),e.appendChild(l()),e.appendChild(u()),e},f=function(){var e=document.createElement("ul");return e.setAttribute("class","task_list"),e};this.addTask=function(e,t,n,a){var r=new Task(a,new Date(n,t,e)),i=t+"_"+n;return this.tasks[i]||(this.tasks[i]=[]),this.tasks[i].push(r),this},this.removeTask=function(e){if(this.tasks[i+"_"+s]){this.tasks[i+"_"+s].forEach(function(t,n,a){t instanceof Task&&t.id===e&&a.splice(n,1)}.bind(this))}return this},this.loadTasksFromStorage=function(){var e=localStorage.getItem(this.tasksLocalStorageKey);try{var t=JSON.parse(e);for(var n in t)this.tasks[n]=[],t[n].forEach(function(e){var t=new Task(e.task,new Date(e.date));this.tasks[n].push(t)}.bind(this))}catch(e){this.tasks={}}},this.setupHandlers=function(){document.querySelector(o).addEventListener("click",calendarNavClickHandler.bind(this));var e=document.querySelector(d);e.addEventListener("click",calendarClickHandler.bind(this)),e.addEventListener("success",modalSuccessHandler.bind(this)),window.addEventListener("pagehide",exitFromPageHandler.bind(this)),window.addEventListener("selectdate",menuSelectDateHandler.bind(this))},this.init=function(){return this.setupHandlers(),this.loadTasksFromStorage(),this},this.renderNavigationPanel=function(){var e=document.querySelector(o);e.innerHTML="",e.appendChild(c(NAMES_OF_MONTHS[i]+" "+s))},this.renderCalendar=function(){var e=document.querySelector(d),t=e.querySelector(this.selector);t&&e.removeChild(t),e.appendChild(m.call(this))},this.renderTasks=function(){var e=this.tasks[i+"_"+s];e&&e.forEach(function(e){var t=document.querySelector(this.selector);if(e instanceof Task){var n=t.querySelector("#day"+e.date.getDate()),a=n.querySelector(".task_list");a||(a=f(),n.insertBefore(a,n.childNodes[0])),a.appendChild(e.render())}}.bind(this))},this.render=function(e,t){return i=isNaN(+e)?i:+e,s=isNaN(+t)?s:+t,this.renderNavigationPanel(),this.renderCalendar(),this.renderTasks(),this},this.previous=function(){return-1==--i&&(i=11,s--),this},this.next=function(){return 12==++i&&(i=0,s++),this},this.toJSON=function(){return this.tasks},this.saveTasksToStorage=function(){localStorage.removeItem(this.tasksLocalStorageKey),localStorage.setItem(this.tasksLocalStorageKey,JSON.stringify(this))}}function calendarClickHandler(e){var t=e.target;if("delete"===t.id){var n=+t.closest(".task").id;return void(isNaN(n)||this.removeTask(n).render())}var a=t.closest("td");a&&(this.chosenDay=a.id.slice(3),this.modal.show("Event on "+this.chosenDay+" "+NAMES_OF_MONTHS[this.month]+" "+this.year))}function modalSuccessHandler(e){this.addTask(this.chosenDay,this.month,this.year,e.detail.message).render()}function calendarNavClickHandler(e){for(var t=e.target;"calendar_nav_container"!==t.id;){if("previous"===t.id){this.previous().render();break}if("next"===t.id){this.next().render();break}t=t.parentNode}}function exitFromPageHandler(e){this.saveTasksToStorage()}function menuSelectDateHandler(e){this.render(e.detail.month,e.detail.year)}var NAMES_OF_MONTHS=["January","February","March","April","May","June","July","August","September","October","November","December"];
function Menu(e,t,n,o){this.selector=e,this.el=document.querySelector(this.selector),this.buttonId=t,this.monthSelectorId=n,this.yearSelectorId=o}function showButtonClickHandler(e){var t=e.target;if(t.id===this.buttonId&&!t.hasAttribute("disabled")){monthSelector=document.getElementById(this.monthSelectorId),yearSelector=document.getElementById(this.yearSelectorId);var n=new CustomEvent("selectdate",{bubbles:!0,detail:{month:monthSelector[monthSelector.selectedIndex].value,year:yearSelector[yearSelector.selectedIndex].value}});this.el.dispatchEvent(n)}}function selectorChangeHandler(){var e=document.getElementById(this.buttonId),t=document.getElementById(this.monthSelectorId),n=document.getElementById(this.yearSelectorId);0!==t.selectedIndex&&0!==n.selectedIndex?e.removeAttribute("disabled"):e.setAttribute("disabled","")}Menu.prototype.init=function(){return this.el.addEventListener("click",showButtonClickHandler.bind(this)),this.el.addEventListener("change",selectorChangeHandler.bind(this)),this},Menu.prototype.renderButton=function(){var e=getSimpleButton(this.buttonId,"Show","is-primary");e.setAttribute("disabled",""),this.el.appendChild(e)},Menu.prototype.renderSelectors=function(){var e=getSelector(this.monthSelectorId);e.appendChild(getOption(-1,"-choose month-"));for(var t=0;t<NAMES_OF_MONTHS.length;t++)e.appendChild(getOption(t,NAMES_OF_MONTHS[t]));this.el.appendChild(e);var n=getSelector(this.yearSelectorId);n.appendChild(getOption(-1,"-choose year-"));for(var o=(new Date).getFullYear();o>=1900;o--)n.appendChild(getOption(o,o));this.el.appendChild(n)},Menu.prototype.render=function(){this.renderButton(),this.renderSelectors()};
function Modal(t){this.modal=document.querySelector(t),this.init()}Modal.prototype.init=function(){this.modal.addEventListener("click",this.modalClickHandler.bind(this)),this.modal.addEventListener("keyup",this.modalKeyUpHandler.bind(this)),this.modal.querySelector("#success_button").disabled=!0},Modal.prototype.modalClickHandler=function(t){var e=t.target;if("success_button"===e.id){var i=new CustomEvent("success",{detail:{message:this.modal.querySelector("#text_input").value},bubbles:!0});this.modal.dispatchEvent(i),this.hide()}"cancel_button"!==e.id&&"close_button"!==e.id||this.hide()},Modal.prototype.modalKeyUpHandler=function(t){var e=t.target;"text_input"===e.id&&(this.modal.querySelector("#success_button").disabled=!e.value)},Modal.prototype.show=function(t){this.modal.querySelector("#title").innerHTML=t||"New Event",this.modal.classList.add("is-active")},Modal.prototype.hide=function(){this.modal.querySelector("#text_input").value="",this.modal.classList.remove("is-active"),this.modal.querySelector("#success_button").disabled=!0};
function Task(t,e){var n=t;this.__defineGetter__("task",function(){return n});var r=e;this.__defineGetter__("date",function(){return r});var i=this.generateId();this.__defineGetter__("id",function(){return i}),this.render=function(){var t=document.createElement("li");return t.appendChild(getTag(this.id,"task","is-primary","is-small",this.task,!0)),t}}Task.prototype.generateId=function(){var t=0;return function(){return t++}}();
var getOption=function(e,t){var n=document.createElement("option");return n.value=e,n.innerHTML=t,n},findChild=function(e,t){for(var n=0;n<e.children.length;n++)if(e.children[n].tagName===t.toUpperCase())return e.children[n];return null},getSelector=function(e){var t=document.createElement("select");return t.setAttribute("id",e),t},getSimpleButton=function(e,t,n){var a=document.createElement("a");a.className="button",a.classList.add(n),a.setAttribute("id",e);var r=document.createTextNode(t);return a.appendChild(r),a},getButton=function(e,t,n){var a=document.createElement("a"),r=document.createElement("span");r.className="icon is-large",r.setAttribute("id",e),a.appendChild(r);var i=document.createElement("i");return i.className=n,i.innerHTML=t,r.appendChild(i),a},getTag=function(e,t,n,a,r,i){var l=document.createElement("span");l.className="tag",l.classList.add(t),l.classList.add(n),l.classList.add(a),l.setAttribute("id",e);var d=document.createTextNode(r);if(l.appendChild(d),i){var c=document.createElement("button");c.className="delete is-small",c.setAttribute("id","delete"),l.appendChild(c)}return l},getColumn=function(e,t){var n=document.createElement("div");return n.className="column",t&&n.classList.add(t),n.appendChild(e),n};Date.prototype.daysInMonth=function(){return 32-new Date(this.getFullYear(),this.getMonth(),32).getDate()},Date.prototype.fullWeeksInMonth=function(){var e=new Date(this.getFullYear(),this.getMonth(),1).getDay();e=0===e?7:e;var t=e-1+this.daysInMonth();return Number(Math.floor(t/7)+Boolean(t%7))};