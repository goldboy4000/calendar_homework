!function(n){"use strict";var e=function(){new LocalizationLoader("data.json").init();new Weather("Minsk","by","metric","ru").getInfo();new Menu("#menu_container","show-button","month-selector","year-selector").init().render(),new Calendar("#calendar_nav_container","#calendar_container").init().render()};n.addEventListener("load",e)}(window);
function Calendar(e,t,n,a){function s(e){this.namesOfDays=e.detail.namesOfDays,this.namesOfMonths=e.detail.namesOfMonths,this.render()}var i=["ПН","ВТ","СР","ЧТ","ПТ","СБ","ВС"];this.chosenDay=(new Date).getDate();var r=isNaN(+n)?(new Date).getMonth():+n,o=isNaN(+a)?(new Date).getFullYear():+a;this.__defineGetter__("month",function(){return r}),this.__defineGetter__("year",function(){return o}),this.namesOfDays=i,this.namesOfMonths=NAMES_OF_MONTHS,this.id="calendar",this.selector="#"+this.id;var d=e,h=t;this.tasks={},this.tasksLocalStorageKey="tasks",this.modal=new Modal(".modal");var l=function(e){var t=document.createElement("div");return t.className="columns",t.appendChild(getColumn(getButton("previous","","fa fa-arrow-circle-o-left"))),t.appendChild(getColumn(getTag("date","title","is-primary","is-large",e),"is-three-quarters")),t.appendChild(getColumn(getButton("next","","fa fa-arrow-circle-o-right"))),t};this.getHeader=function(){var e=document.createElement("thead"),t=document.createElement("tr");e.appendChild(t);for(var n=0;n<this.namesOfDays.length;n++)t.appendChild(c(this.namesOfDays[n]));return e};var c=function(e){var t=document.createElement("th");return t.innerHTML=e,t};this.getBody=function(){for(var e=document.createElement("tbody"),t=new Date(o,r),n=0===t.getDay()?7:t.getDay(),a=t.daysInMonth(),s=1,i=[],d=!0,h=0;h<t.fullWeeksInMonth();h++){i[h]=document.createElement("tr"),e.appendChild(i[h]);for(var l=1;l<=7;l++)column=document.createElement("td"),l<n&&d||s>a?column.innerHTML="&nbsp":(column.setAttribute("id","day"+s),column.innerHTML=s++,d=!1),i[h].appendChild(column)}return e},this.getCalendarElement=function(){var e=document.createElement("table");return e.className="table is-bordered",e.setAttribute("id",this.id),e.appendChild(this.getHeader()),e.appendChild(this.getBody()),e};var u=function(){var e=document.createElement("ul");return e.setAttribute("class","task_list"),e};this.addTask=function(e,t,n,a){var s=new Task(a,new Date(n,t,e)),i=t+"_"+n;return this.tasks[i]||(this.tasks[i]=[]),this.tasks[i].push(s),this},this.removeTask=function(e){if(this.tasks[r+"_"+o]){this.tasks[r+"_"+o].forEach(function(t,n,a){t instanceof Task&&t.id===e&&a.splice(n,1)}.bind(this))}return this},this.loadTasksFromStorage=function(){var e=localStorage.getItem(this.tasksLocalStorageKey);try{var t=JSON.parse(e);for(var n in t)this.tasks[n]=[],t[n].forEach(function(e){var t=new Task(e.task,new Date(e.date));this.tasks[n].push(t)}.bind(this))}catch(e){this.tasks={}}},this.setupHandlers=function(){document.querySelector(d).addEventListener("click",calendarNavClickHandler.bind(this));var e=document.querySelector(h);e.addEventListener("click",calendarClickHandler.bind(this)),e.addEventListener("success",modalSuccessHandler.bind(this)),window.addEventListener("pagehide",exitFromPageHandler.bind(this)),window.addEventListener("selectdate",menuSelectDateHandler.bind(this)),window.addEventListener("locload",s.bind(this))},this.init=function(){return this.setupHandlers(),this.loadTasksFromStorage(),this},this.renderNavigationPanel=function(){var e=document.querySelector(d);e.innerHTML="",e.appendChild(l(this.namesOfMonths[r]+" "+o))},this.renderCalendar=function(){var e=document.querySelector(h),t=e.querySelector(this.selector);t&&e.removeChild(t),e.appendChild(this.getCalendarElement())},this.renderTasks=function(){var e=this.tasks[r+"_"+o];e&&e.forEach(function(e){var t=document.querySelector(this.selector);if(e instanceof Task){var n=t.querySelector("#day"+e.date.getDate()),a=n.querySelector(".task_list");a||(a=u(),n.insertBefore(a,n.childNodes[0])),a.appendChild(e.render())}}.bind(this))},this.render=function(e,t){return r=isNaN(+e)?r:+e,o=isNaN(+t)?o:+t,this.renderNavigationPanel(),this.renderCalendar(),this.renderTasks(),this},this.previous=function(){return-1==--r&&(r=11,o--),this},this.next=function(){return 12==++r&&(r=0,o++),this},this.toJSON=function(){return this.tasks},this.saveTasksToStorage=function(){localStorage.removeItem(this.tasksLocalStorageKey),localStorage.setItem(this.tasksLocalStorageKey,JSON.stringify(this))}}function calendarClickHandler(e){var t=e.target;if("delete"===t.id){var n=+t.closest(".task").id;return void(isNaN(n)||this.removeTask(n).render())}var a=t.closest("td");a&&(this.chosenDay=a.id.slice(3),this.modal.show("Event on "+this.chosenDay+" "+this.namesOfMonths[this.month]+" "+this.year))}function modalSuccessHandler(e){this.addTask(this.chosenDay,this.month,this.year,e.detail.message).render()}function calendarNavClickHandler(e){for(var t=e.target;"calendar_nav_container"!==t.id;){if("previous"===t.id){this.previous().render();break}if("next"===t.id){this.next().render();break}t=t.parentNode}}function exitFromPageHandler(e){this.saveTasksToStorage()}function menuSelectDateHandler(e){this.render(e.detail.month,e.detail.year)}var NAMES_OF_MONTHS=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
function LocalizationLoader(t){this.localization="ru",this.source=t}function langChangeHandler(t){this.localization=t.detail.lang,this.load()}function readyStateChangeHandler(t){if(4===t.target.readyState)if(200!==t.target.status)console.log("status = "+t.target.status);else{var a=this.parse(t.target.responseText);if(a){var e=new CustomEvent("locload",{bubbles:!0,detail:{namesOfDays:a.namesOfDays,namesOfMonths:a.namesOfMonths}});window.dispatchEvent(e)}}}LocalizationLoader.prototype.init=function(){window.addEventListener("langchange",langChangeHandler.bind(this))},LocalizationLoader.prototype.load=function(){var t=new XMLHttpRequest;t.addEventListener("readystatechange",readyStateChangeHandler.bind(this)),t.open("GET",this.source,!0),t.send()},LocalizationLoader.prototype.parse=function(t){try{var a=JSON.parse(t)}catch(t){return null}return a[this.localization+"Lang"]};
function Menu(e,t,n,i){function o(e){this.namesOfMonths=e.detail.namesOfMonths,this.fillMonthSelector()}this.selector=e,this.el=document.querySelector(this.selector),this.buttonId=t,this.monthSelectorId=n,this.yearSelectorId=i,this.namesOfMonths=NAMES_OF_MONTHS,this.localization="ru",this.selectedMonth=0,this.init=function(){return this.el.addEventListener("click",showButtonClickHandler.bind(this)),this.el.addEventListener("change",selectorChangeHandler.bind(this)),window.addEventListener("locload",o.bind(this)),this},this.fillMonthSelector=function(){var e=document.getElementById(this.monthSelectorId);e.innerHTML="",e.appendChild(getOption(-1,"-choose month-"));for(var t=0;t<this.namesOfMonths.length;t++)e.appendChild(getOption(t,this.namesOfMonths[t]));e.selectedIndex=this.selectedMonth},this.toggleLocButtons=function(){var e=document.getElementById("ru-lang-button"),t=document.getElementById("en-lang-button");"ru"===this.localization?(e.classList.add("is-outlined"),t.classList.remove("is-outlined")):(e.classList.remove("is-outlined"),t.classList.add("is-outlined"))}}function showButtonClickHandler(e){var t=e.target;if(t.id===this.buttonId&&!t.hasAttribute("disabled")){monthSelector=document.getElementById(this.monthSelectorId),yearSelector=document.getElementById(this.yearSelectorId);var n=new CustomEvent("selectdate",{bubbles:!0,detail:{month:monthSelector[monthSelector.selectedIndex].value,year:yearSelector[yearSelector.selectedIndex].value}});this.el.dispatchEvent(n)}}function selectorChangeHandler(){var e=document.getElementById(this.buttonId),t=document.getElementById(this.monthSelectorId),n=document.getElementById(this.yearSelectorId);this.selectedMonth=t.selectedIndex,0!==t.selectedIndex&&0!==n.selectedIndex?e.removeAttribute("disabled"):e.setAttribute("disabled","")}function locClickHandler(e){this.localization=e.target.id.slice(0,2),this.toggleLocButtons();var t=new CustomEvent("langchange",{bubbles:!0,detail:{lang:this.localization}});this.el.dispatchEvent(t)}Menu.prototype.renderButton=function(){var e=getSimpleButton(this.buttonId,"Show","is-primary");e.setAttribute("disabled",""),this.el.appendChild(e)},Menu.prototype.renderSelectors=function(){var e=getSelector(this.monthSelectorId);this.el.appendChild(e),this.fillMonthSelector();var t=getSelector(this.yearSelectorId);t.appendChild(getOption(-1,"-choose year-"));for(var n=(new Date).getFullYear();n>=1900;n--)t.appendChild(getOption(n,n));this.el.appendChild(t)},Menu.prototype.renderLocalizationMenu=function(){var e=getSimpleButton("ru-lang-button","ru","is-info");e.addEventListener("click",locClickHandler.bind(this));var t=getSimpleButton("en-lang-button","en","is-info");t.addEventListener("click",locClickHandler.bind(this)),this.el.appendChild(e),this.el.appendChild(t),this.toggleLocButtons()},Menu.prototype.render=function(){this.el.innerHTML="",this.renderButton(),this.renderSelectors(),this.renderLocalizationMenu()};
function Modal(t){this.modal=document.querySelector(t),this.init()}Modal.prototype.init=function(){this.modal.addEventListener("click",this.modalClickHandler.bind(this)),this.modal.addEventListener("keyup",this.modalKeyUpHandler.bind(this)),this.modal.querySelector("#success_button").disabled=!0},Modal.prototype.modalClickHandler=function(t){var e=t.target;if("success_button"===e.id){var i=new CustomEvent("success",{detail:{message:this.modal.querySelector("#text_input").value},bubbles:!0});this.modal.dispatchEvent(i),this.hide()}"cancel_button"!==e.id&&"close_button"!==e.id||this.hide()},Modal.prototype.modalKeyUpHandler=function(t){var e=t.target;"text_input"===e.id&&(this.modal.querySelector("#success_button").disabled=!e.value)},Modal.prototype.show=function(t){this.modal.querySelector("#title").innerHTML=t||"New Event",this.modal.classList.add("is-active")},Modal.prototype.hide=function(){this.modal.querySelector("#text_input").value="",this.modal.classList.remove("is-active"),this.modal.querySelector("#success_button").disabled=!0};
function Task(t,e){var n=t;this.__defineGetter__("task",function(){return n});var r=e;this.__defineGetter__("date",function(){return r});var i=this.generateId();this.__defineGetter__("id",function(){return i}),this.render=function(){var t=document.createElement("li");return t.appendChild(getTag(this.id,"task","is-primary","is-small",this.task,!0)),t}}Task.prototype.generateId=function(){var t=0;return function(){return t++}}();
var getOption=function(e,t){var n=document.createElement("option");return n.value=e,n.innerHTML=t,n},findChild=function(e,t){for(var n=0;n<e.children.length;n++)if(e.children[n].tagName===t.toUpperCase())return e.children[n];return null},getSelector=function(e){var t=document.createElement("select");return t.setAttribute("id",e),t},getSimpleButton=function(e,t,n){var a=document.createElement("a");a.className="button",a.classList.add(n),a.setAttribute("id",e);var r=document.createTextNode(t);return a.appendChild(r),a},getButton=function(e,t,n){var a=document.createElement("a"),r=document.createElement("span");r.className="icon is-large",r.setAttribute("id",e),a.appendChild(r);var i=document.createElement("i");return i.className=n,i.innerHTML=t,r.appendChild(i),a},getTag=function(e,t,n,a,r,i){var l=document.createElement("span");l.className="tag",l.classList.add(t),l.classList.add(n),l.classList.add(a),l.setAttribute("id",e);var d=document.createTextNode(r);if(l.appendChild(d),i){var c=document.createElement("button");c.className="delete is-small",c.setAttribute("id","delete"),l.appendChild(c)}return l},getColumn=function(e,t){var n=document.createElement("div");return n.className="column",t&&n.classList.add(t),n.appendChild(e),n};Date.prototype.daysInMonth=function(){return 32-new Date(this.getFullYear(),this.getMonth(),32).getDate()},Date.prototype.fullWeeksInMonth=function(){var e=new Date(this.getFullYear(),this.getMonth(),1).getDay();e=0===e?7:e;var t=e-1+this.daysInMonth();return Number(Math.floor(t/7)+Boolean(t%7))};
function Weather(e,t,a,n){this.element=document.querySelector("#weather-box"),this.city=e||"Minsk",this.country=t||"by",this.units=a||"metric",this.lang=n||"ru",this.xhr=new XMLHttpRequest,this.init()}function clickHandler(e){"close-weather"===e.target.id&&(this.element.style.display="none"),"forecast-three-days"===e.target.id&&(this.getInfo("http://api.openweathermap.org/data/2.5/forecast?q="),e.target.style.display="none")}function loadWeatherHandler(e){var t=e.target;if(200!==t.status)console.log("status = "+t.status);else{var a=this.parse(t.responseText);a&&this.render(a)}}Weather.prototype.init=function(){this.element.addEventListener("click",clickHandler.bind(this)),this.xhr.addEventListener("load",loadWeatherHandler.bind(this))},Weather.prototype.getInfo=function(e){var e=e||"http://api.openweathermap.org/data/2.5/weather?q=";this.xhr.open("GET",e+this.city+","+this.country+"&APPID=fac89aa646dd8482a386ae7aa00fcdbb&units="+this.units+"&lang="+this.lang,!0),this.xhr.send()},Weather.prototype.render=function(e){if(e.list){this.element.removeChild(this.element.querySelector(".media"));var t=new Date,a=0;e.list.forEach(function(e){var n=new Date(e.dt_txt);t.getHours()>12&&!a&&(this.element.appendChild(this.renderForecast(this.getForecastObject(e))),a++),12===n.getHours()&&a<3&&(this.element.appendChild(this.renderForecast(this.getForecastObject(e))),a++)}.bind(this))}else this.element.appendChild(this.renderForecast(this.getForecastObject(e)))},Weather.prototype.getForecastObject=function(e){var t={};e.weather[0]&&(t.image="http://openweathermap.org/img/w/"+e.weather[0].icon+".png",t.description=e.weather[0].description);var a="";return+e.main.temp>0?a="+":+e.main.temp<0&&(a="-"),t.temperature=a+Math.floor(e.main.temp)+"℃",t.city=e.name||"",t},Weather.prototype.renderForecast=function(e){var t=document.createElement("img");t.src=e.image,t.alt="Image";var a=document.createElement("figure");a.className="image is-64x64",a.appendChild(t);var n=document.createElement("div");n.className="media-left",n.appendChild(a);var r=document.createElement("span");r.innerHTML=e.temperature;var i=document.createElement("span");i.innerHTML=e.city;var s=document.createElement("span");s.innerHTML=e.description;var c=document.createElement("br"),d=document.createTextNode(" "),o=document.createElement("div");o.className="content",o.appendChild(r),o.appendChild(d),o.appendChild(i),o.appendChild(c),o.appendChild(s);var h=document.createElement("div");h.className="media-content",h.appendChild(o);var l=document.createElement("article");return l.className="media",l.appendChild(n),l.appendChild(h),l},Weather.prototype.parse=function(e){try{var t=JSON.parse(e)}catch(e){return null}return t};